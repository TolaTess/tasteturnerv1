rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================================================
    // USERS COLLECTION
    // ============================================================================
    match /users/{userId} {
      // Users can read their own profile and public profiles
      allow read: if isAuthenticated();
      
      // Users can only create/update their own profile
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
      
      // User subcollections
      match /daily_summary/{date} {
        // Users can only access their own daily summaries
        allow read, write: if isOwner(userId);
      }
      
      match /health_journal/{date} {
        // Users can only access their own health journal entries
        allow read, write: if isOwner(userId);
      }
      
      match /token_usage/{usageId} {
        // Users can only access their own token usage data
        allow read, write: if isOwner(userId);
      }
      
      match /token_usage_daily/{date} {
        // Users can only access their own daily token usage aggregates
        allow read, write: if isOwner(userId);
      }
      
      match /ai_cache/{cacheKey} {
        // Users can only access their own AI cache entries
        allow read, write: if isOwner(userId);
      }
      
      match /badges/{badgeId} {
        // Users can read their own badges
        allow read: if isOwner(userId);
        // Only cloud functions can write badges
        allow write: if false;
      }
    }
    
    // ============================================================================
    // POSTS COLLECTION
    // ============================================================================
    match /posts/{postId} {
      // Anyone authenticated can read posts
      allow read: if isAuthenticated();
      
      // Users can create posts (must set their userId)
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Users can update/delete their own posts
      allow update, delete: if isAuthenticated() && 
                               resource.data.userId == request.auth.uid;
    }
    
    // ============================================================================
    // MEALS COLLECTION
    // ============================================================================
    match /meals/{mealId} {
      // Anyone authenticated can read meals
      allow read: if isAuthenticated();
      
      // Users can create meals (must set their userId)
      allow create: if isAuthenticated() && 
                       (request.resource.data.userId == request.auth.uid ||
                        request.resource.data.userId == null); // Allow cloud functions
      
      // Users can update their own meals, or cloud functions can update any
      allow update: if isAuthenticated() && 
                      (resource.data.userId == request.auth.uid ||
                       request.resource.data.userId == null); // Cloud function
      
      // Users can delete their own meals
      allow delete: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid;
    }
    
    // ============================================================================
    // INGREDIENTS COLLECTION
    // ============================================================================
    match /ingredients/{ingredientId} {
      // Anyone (including non-registered users) can read ingredients
      // Needed for app to load and function properly
      allow read: if true;
      
      // Only cloud functions can create/update ingredients
      allow create, update: if false; // Cloud functions use admin SDK
      allow delete: if false;
    }
    
    // ============================================================================
    // GENERAL COLLECTION (App configuration and public data)
    // ============================================================================
    match /general/{documentId} {
      // Anyone (including non-registered users) can read general data
      // This includes app configuration, excluded ingredients, etc.
      // Needed for app to load properly before user authentication
      allow read: if true;
      
      // Only cloud functions can write general data
      allow write: if false; // Cloud functions use admin SDK
    }
    
    // ============================================================================
    // HEADERS COLLECTION (Dietary headers for meal generation)
    // ============================================================================
    match /headers/{headerId} {
      // Anyone (including non-registered users) can read headers
      // Needed for meal generation UI to function properly
      allow read: if true;
      
      // Only cloud functions can write headers
      allow write: if false; // Cloud functions use admin SDK
    }
    
    // ============================================================================
    // CATEGORY COLLECTION (Meal categories)
    // ============================================================================
    match /category/{categoryId} {
      // Anyone (including non-registered users) can read categories
      // Needed for meal generation UI to function properly
      allow read: if true;
      
      // Only cloud functions can write categories
      allow write: if false; // Cloud functions use admin SDK
    }
    
    // ============================================================================
    // USER MEALS COLLECTION (Daily meal tracking)
    // ============================================================================
    match /userMeals/{userId} {
      // Users can only access their own meal data
      allow read, write: if isOwner(userId);
      
      match /meals/{date} {
        // Users can only access their own daily meals
        allow read, write: if isOwner(userId);
      }
      
      match /shoppingList/{weekId} {
        // Users can only access their own shopping lists
        allow read, write: if isOwner(userId);
      }
    }
    
    // ============================================================================
    // MEAL PLANS COLLECTION
    // ============================================================================
    match /mealPlans/{userId} {
      // Users can only access their own meal plans
      allow read, write: if isOwner(userId);
      
      match /buddy/{date} {
        // Users can only access their own buddy meal plans (proposals)
        allow read, write: if isOwner(userId);
      }
      
      match /date/{date} {
        // Users can only access their own committed meal plans
        allow read, write: if isOwner(userId);
      }
    }
    
    // ============================================================================
    // BADGES COLLECTION (Available badges - top level)
    // ============================================================================
    match /badges/{badgeId} {
      // Authenticated users can read available badges
      allow read: if isAuthenticated();
      
      // Only cloud functions can write badges
      allow write: if false; // Cloud functions use admin SDK
    }
    
    // ============================================================================
    // PROGRAM TRACKING COLLECTION (User program progress)
    // ============================================================================
    match /programTracking/{userId} {
      // Users can only access their own program tracking
      allow read, write: if isOwner(userId);
      
      match /programs/{programId} {
        // Users can only access their own program progress
        allow read, write: if isOwner(userId);
      }
    }
    
    // ============================================================================
    // SHARED CALENDARS COLLECTION
    // ============================================================================
    match /shared_calendars/{calendarId} {
      // Users can read calendars they're part of (userId in userIds array)
      allow read: if isAuthenticated() && 
                     (resource.data.userIds != null &&
                      request.auth.uid in resource.data.userIds);
      
      // Users can create calendars (must set themselves as owner and in userIds)
      allow create: if isAuthenticated() && 
                       request.resource.data.owner == request.auth.uid &&
                       request.resource.data.userIds != null &&
                       request.auth.uid in request.resource.data.userIds;
      
      // Users can update calendars they own or are part of
      // Can add users to userIds array, but cannot remove themselves if they're the owner
      allow update: if isAuthenticated() && 
                      resource.data.userIds != null &&
                      request.auth.uid in resource.data.userIds &&
                      // Ensure userIds array still contains the user after update
                      (request.resource.data.userIds == null ||
                       request.auth.uid in request.resource.data.userIds);
      
      // Only owners can delete calendars
      allow delete: if isAuthenticated() && 
                      resource.data.owner == request.auth.uid;
    }
    
    // ============================================================================
    // COUNTERS COLLECTION (App counters like user numbers)
    // ============================================================================
    match /counters/{counterId} {
      // Authenticated users can read counters
      allow read: if isAuthenticated();
      
      // Only cloud functions can write counters
      allow write: if false; // Cloud functions use admin SDK
    }
    
    // ============================================================================
    // BATTLE PARTICIPANTS COLLECTION
    // ============================================================================
    match /battle_participants/{battleId} {
      // Authenticated users can read battle participants
      allow read: if isAuthenticated();
      
      // Only cloud functions can write battle participants
      allow write: if false; // Cloud functions use admin SDK
    }
    
    // ============================================================================
    // BATTLE WINNERS COLLECTION
    // ============================================================================
    match /battle_winners/{battleId} {
      // Authenticated users can read battle winners
      allow read: if isAuthenticated();
      
      // Only cloud functions can write battle winners
      allow write: if false; // Cloud functions use admin SDK
    }
    
    // ============================================================================
    // CHATS COLLECTION
    // ============================================================================
    match /chats/{chatId} {
      // Helper function to check if user is in participants array (for existing chats)
      function isParticipant() {
        return resource.data.participants != null &&
               request.auth.uid in resource.data.participants;
      }
      
      // Helper function to check if user is in participants array (for new chats)
      function isParticipantInRequest() {
        return request.resource.data.participants != null &&
               request.auth.uid in request.resource.data.participants;
      }
      
      // Helper function to safely check buddyChatId (only use when necessary)
      function isBuddyChat() {
        let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
        return userDoc != null && 
               userDoc.data != null &&
               userDoc.data.buddyChatId != null &&
               userDoc.data.buddyChatId == chatId;
      }
      
      // Helper function to check if user can access chat (for message operations)
      function canAccessChat() {
        // Check if chatId matches userId (user's own chat)
        return chatId == request.auth.uid ||
               // Check if user is in participants array
               (resource.data.participants != null &&
                request.auth.uid in resource.data.participants) ||
               // Check buddyChatId as fallback (only if other checks fail)
               isBuddyChat();
      }
      
      // Users can read chats they're part of (by chatId, buddyChatId, or participants array)
      allow read: if isAuthenticated() && 
                     (chatId == request.auth.uid ||
                      isParticipant() ||
                      isBuddyChat());
      
      // Users can create chats (must include themselves in participants)
      allow create: if isAuthenticated() && 
                       isParticipantInRequest();
      
      // Users can update chats they're part of
      allow update: if isAuthenticated() && 
                      (chatId == request.auth.uid ||
                       isParticipant() ||
                       isBuddyChat());
      
      // Users can delete their own chats
      allow delete: if isAuthenticated() && chatId == request.auth.uid;
      
      match /messages/{messageId} {
        // Users can read messages in chats they're part of
        allow read: if isAuthenticated() && canAccessChat();
        
        // Users can create messages in chats they're part of
        // Check parent chat document to verify access
        allow create: if isAuthenticated() && 
                        canAccessChat() &&
                        request.resource.data.senderId == request.auth.uid;
        
        // Users can update/delete their own messages
        allow update, delete: if isAuthenticated() && 
                                 resource.data.senderId == request.auth.uid;
      }
    }
    
    // ============================================================================
    // USER POSTS COLLECTION (Post references)
    // ============================================================================
    match /usersPosts/{userId} {
      // Users can read their own post references
      allow read: if isOwner(userId);
      
      // Only cloud functions should write to this (via batch operations)
      allow write: if false; // Handled by cloud functions or batch operations
    }
    
    // ============================================================================
    // POINTS COLLECTION
    // ============================================================================
    match /points/{userId} {
      // Users can read their own points
      allow read: if isOwner(userId);
      
      // Only cloud functions can update points (badge rewards)
      allow write: if false; // Handled by cloud functions
    }
    
    // ============================================================================
    // USER BADGE PROGRESS COLLECTION
    // ============================================================================
    match /user_badge_progress/{userId} {
      // Users can read their own badge progress
      allow read: if isOwner(userId);
      
      match /badges/{badgeId} {
        // Users can read their own badges
        allow read: if isOwner(userId);
        // Only cloud functions can write badges
        allow write: if false; // Handled by cloud functions
      }
    }
    
    // ============================================================================
    // PROGRAMS COLLECTION (Public program templates)
    // ============================================================================
    match /programs/{programId} {
      // Authenticated users can read all programs (templates)
      allow read: if isAuthenticated();
      
      // Only cloud functions can create/update programs
      allow write: if false; // Cloud functions use admin SDK
    }
    
    // ============================================================================
    // USER PROGRAM COLLECTION (User program enrollments)
    // ============================================================================
    match /userProgram/{programId} {
      // Authenticated users can read to check enrollment status
      // This is needed for checking if user is already enrolled before joining
      allow read: if isAuthenticated();
      
      // Users can create their own program enrollments
      allow create: if isAuthenticated() && 
                       request.resource.data.userIds != null &&
                       request.auth.uid in request.resource.data.userIds;
      
      // Users can update to add themselves to userIds array using arrayUnion
      // This allows users to join programs by adding themselves to existing documents
      // Security: User must be in the new userIds array, and array size can only increase
      allow update: if isAuthenticated() && 
                       request.resource.data.userIds != null &&
                       request.auth.uid in request.resource.data.userIds &&
                       // Prevent removing users - array size must stay same or increase
                       (resource.data.userIds == null || 
                        request.resource.data.userIds.size() >= resource.data.userIds.size());
      
      // Only cloud functions can delete program enrollments
      allow delete: if false; // Cloud functions use admin SDK
    }
    
    // ============================================================================
    // FRIENDS COLLECTION (User following/followers)
    // ============================================================================
    match /friends/{userId} {
      // Users can read their own friends data
      allow read: if isOwner(userId);
      
      // Users can create/update their own friends document
      allow create, update: if isOwner(userId);
      
      // Users can delete their own friends document
      allow delete: if isOwner(userId);
    }
    
    // ============================================================================
    // DEFAULT DENY
    // ============================================================================
    // Any collection not explicitly matched above will be denied
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

